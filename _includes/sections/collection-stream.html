{%- comment -%}
Renders a stream of collection items with optional single-key filtering, sorting, and limiting.

Parameters:
  collection: collection name (include.collection or section.data.collection)
  filter_key: front-matter key to filter by (optional)
  filter_values: array or scalar of filter values (optional)
  label: heading shown above the stream (optional; falls back to section data)
  show_hr: render an <hr> above the section when true (default false)
  sort_by: key to sort by (include.sort_by or section.data.sort_by)
  reverse: boolean to reverse results (include.reverse or section.data.reverse)
  excerpt_length: passed to collection-item include
  post_display_limit: max items to show
{%- endcomment -%}

{%- assign coll_name = include.collection | default: section.data.collection -%}

{%- comment -%} obtain posts array robustly {%- endcomment -%}
{%- assign posts = site[coll_name] -%}
{%- if posts == nil or posts == empty -%}
  {%- assign coll_obj = site.collections[coll_name] -%}
  {%- if coll_obj and coll_obj.docs -%}
    {%- assign posts = coll_obj.docs -%}
  {%- else -%}
    {%- assign posts = "" -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} filter inputs (single-key mode) {%- endcomment -%}
{%- assign keyname = include.filter_key | default: nil -%}
{%- assign fv = include.filter_values | default: nil -%}
{%- if fv -%}
  {%- assign fv = fv | array -%}
{%- endif -%}

{%- comment -%} build filtered_posts: preserve Document objects {%- endcomment -%}
{%- assign filtered_posts = posts | slice: 0, 0 -%}

{%- if posts and posts != empty -%}
  {%- for post in posts -%}
    {%- assign keep = true -%}

    {%- if keyname and fv and fv != empty -%}
      {%- comment -%} get the post's values for the key (normalize to array) {%- endcomment -%}
      {%- assign post_values = post[keyname] -%}

      {%- if post_values == nil -%}
        {%- assign filename = post.path | split:"/" | last -%}
        {%- assign slug = filename | split:"." | first -%}
        {%- assign post_values = slug | split:"|" -%}
      {%- endif -%}

      {%- assign post_values = post_values | array -%}

      {%- comment -%} check for any intersection between fv and post_values {%- endcomment -%}
      {%- assign matched = false -%}
      {%- for v in post_values -%}
        {%- if fv contains v -%}
          {%- assign matched = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if matched == false -%}
        {%- assign keep = false -%}
      {%- endif -%}
    {%- endif -%}

    {%- if keep -%}
      {%- assign filtered_posts = filtered_posts | push: post -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} sorting / reversing / limiting {%- endcomment -%}
{%- assign sort_key_field = include.sort_by | default: section.data.sort_by | default: "published_date" -%}
{%- assign reverse_flag = include.reverse | default: section.data.reverse | default: false -%}
{%- assign post_display_limit = include.post_display_limit | default: section.data.post_display_limit | default: nil -%}
{%- assign show_all_toggle = include.show_all_toggle | default: section.data.show_all_toggle | default: false -%}

{%- assign sorted_posts = filtered_posts | sort: sort_key_field -%}
{%- if reverse_flag -%}
  {%- assign sorted_posts = sorted_posts | reverse -%}
{%- endif -%}

{%- assign initial_limit = nil -%}
{%- if show_all_toggle and post_display_limit -%}
  {%- assign initial_limit = post_display_limit | plus: 0 -%}
{%- endif -%}

{%- assign loop_posts = sorted_posts -%}
{%- if initial_limit == nil and post_display_limit -%}
  {%- assign loop_posts = sorted_posts | slice: 0, post_display_limit -%}
{%- endif -%}

{%- assign total_posts_count = sorted_posts | size -%}
{%- assign posts_count = loop_posts | size -%}
{%- if initial_limit -%}
  {%- assign posts_count = total_posts_count -%}
{%- endif -%}
{%- assign D = section.data | default: nil -%}
{%- assign label = include.label -%}
{%- if label == nil and D -%}
  {%- assign label = D.label -%}
{%- endif -%}

{%- assign content_md = include.content_md -%}
{%- if content_md == nil and D -%}
  {%- assign content_md = D.content -%}
{%- endif -%}
{%- if content_md == nil and D and D.field -%}
  {%- assign content_md = page[D.field] -%}
{%- endif -%}
{%- assign show_hr = include.show_hr | default: section.data.show_hr | default: false -%}

{%- if posts_count > 0 -%}
  {%- if show_hr -%}
    <hr>
  {%- endif -%}
  {%- assign section_attrs = 'id="collection-stream" class="md-flow"' -%}
  {%- if initial_limit -%}
    {%- capture section_attrs -%}id="collection-stream" class="md-flow" data-collection-stream="toggle" data-initial-limit="{{ initial_limit }}"{%- endcapture -%}
  {%- endif -%}
  <section {{ section_attrs }}>
    {%- if label -%}<h2>{{ label }}</h2>{%- endif -%}
    {%- if content_md -%}
      {{ content_md | markdownify }}
    {%- endif -%}
    {%- for post in loop_posts -%}
      {%- assign hide_item = false -%}
      {%- if initial_limit and total_posts_count > initial_limit and forloop.index0 >= initial_limit -%}
        {%- assign hide_item = true -%}
      {%- endif -%}
      <div class="collection-stream-item{% if hide_item %} is-hidden{% endif %}" data-collection-item>
        {% include sections/collection-item.html post=post excerpt_length=include.excerpt_length %}
      </div>
    {%- endfor -%}
    {%- if initial_limit and total_posts_count > initial_limit -%}
      <button
        type="button"
        class="collection-stream-toggle"
        data-collection-toggle
        data-expand-label="Show All"
        data-collapse-label="Show Less"
        aria-expanded="false">
        Show All
      </button>
    {%- endif -%}
  </section>
{%- endif -%}
