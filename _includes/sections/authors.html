{%- comment -%}
Authors grid section — collection-only, strict slug mode.

Renders author cards via the shared card-stream layout.

Data sources:
- Default: all docs from the `authors` collection → `site.authors`.
- Override: pass `include.authors` to render a specific subset.
  * Accepted forms for `include.authors`:
    - An array of slugs (preferred): ["michael-basil", "kyle-ingersoll"]
    - A JSON-ish string array: '["michael-basil","kyle-ingersoll"]'
    - A comma-separated string: "michael-basil,kyle-ingersoll"
    - A single slug string: "michael-basil"
  * In override mode, only docs whose `slug` matches one of the listed slugs are rendered.

Optional filtering & framing (via `section.data.leadership_flow`):
  leadership_flow:
    label: string (optional heading shown above the grid)
    designation_type: string (e.g., "program", "project") — keeps authors that have a matching designation
    limit: integer — max number of cards to render after sorting

Other behavior:
- `active` defaults to true when missing.
- Sorting: program_level DESC (by negation) then program_level_date/join_date ASC.

Example usages:
  {% include sections/authors.html section=section %}                         {# all authors #}
  {% include sections/authors.html section=section authors=page.slug %}       {# one author #}
  {% include sections/authors.html section=section authors="a,b" %}           {# subset by slugs #}
{%- endcomment -%}

{%- assign D = section.data | default: {} -%}
{%- assign designation_type = D.leadership_flow.designation_type | default: '' | downcase | strip -%}

{%- comment -%} Normalize include.authors (slugs) to an array {%- endcomment -%}
{%- assign use_override = include.authors and include.authors != "" -%}
{%- if use_override -%}
  {%- assign raw = include.authors -%}
  {%- if raw[0] != nil -%}
    {%- assign slugs = raw -%}
  {%- elsif raw contains '[' and raw contains ']' -%}
    {%- assign tmp = raw | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
    {%- assign slugs = tmp | split:',' | map:'strip' -%}
  {%- elsif raw contains ',' -%}
    {%- assign slugs = raw | split:',' | map:'strip' -%}
  {%- else -%}
    {%- assign slugs = raw | split:'\n' | map:'strip' -%}
  {%- endif -%}
  {%- comment -%} Strict: keep only docs whose slug is explicitly listed {%- endcomment -%}
  {%- assign docs = "" | split:"|" -%}
  {%- for s in slugs -%}
    {%- assign s = s | split:'.' | first | downcase | strip -%}
    {%- assign doc = site.authors | where:"slug", s | first -%}
    {%- if doc -%}{%- assign docs = docs | push: doc -%}{%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign docs = site.authors -%}
{%- endif -%}

{%- comment -%} Filter by slug presence, active, and optional designation_type {%- endcomment -%}
{%- assign filtered = "" | split:"|" -%}
{%- for a in docs -%}
  {%- if a.slug and a.slug != '' -%}
    {%- assign show = a.active | default:true -%}
    {%- if show and designation_type != '' -%}
      {%- assign show = false -%}
      {%- assign ld = a.leadership_designations -%}
      {%- if ld and ld.size > 0 -%}
        {%- for item in ld -%}
          {%- assign t = item.type | downcase | strip -%}
          {%- assign v = item.value | default:item.key | to_s | strip -%}
          {%- if t == designation_type and v != '' and v != 'null' -%}
            {%- assign show = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}
    {%- if show -%}
      {%- assign filtered = filtered | push: a -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Sort: program_level DESC (via negation), then by date ASC {%- endcomment -%}
{%- assign entries = "" | split:"|" -%}
{%- for a in filtered -%}
  {%- assign neg_program = a.program_level | times:-1 | plus:1000 | prepend:"0000" | slice:-4,4 -%}
  {%- assign bld = a.program_level_date | default:a.join_date | default:"9999-12-31" -%}
  {% capture entry %}{{ neg_program }}|{{ bld }}|{{ a.slug }}{% endcapture %}
  {%- assign entries = entries | push: entry -%}
{%- endfor -%}
{%- assign entries = entries | sort -%}

{%- if D.leadership_flow and D.leadership_flow.limit -%}
  {%- assign lim = D.leadership_flow.limit | plus:0 -%}
  {%- if lim > 0 and entries.size > lim -%}
    {%- assign entries = entries | slice:0, lim -%}
  {%- endif -%}
{%- endif -%}

{%- assign author_cards = "" | split:"|" -%}
{%- for e in entries -%}
  {%- assign parts = e | split:'|' -%}
  {%- assign slug  = parts[2] -%}
  {%- assign doc   = site.authors | where:"slug", slug | first -%}
  {%- if doc -%}
    {%- assign author_cards = author_cards | push: doc -%}
  {%- endif -%}
{%- endfor -%}

{%- if section -%}
<section class="md-flow card-stream">
  {%- if D.leadership_flow and D.leadership_flow.label -%}
    <h2>{{ D.leadership_flow.label }}</h2>
  {%- endif -%}
  {% include sections/card-grid.html
    items=author_cards
    item_partial="sections/author.html"
    wrapper_class="card-grid-authors" %}
</section>
{%- else -%}
  {% include sections/card-grid.html
    items=author_cards
    item_partial="sections/author.html"
    wrapper_class="card-grid-authors" %}
{%- endif -%}
