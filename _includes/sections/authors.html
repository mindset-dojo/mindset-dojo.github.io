{%- comment -%}
Authors grid section — collection-only, strict slug mode.

Renders author cards via the shared card-stream layout.

Data sources:
- Default: all docs from the `authors` collection → `site.authors`.
- Override: pass `include.authors` to render a specific subset.
  * Accepted forms for `include.authors`:
    - An array of slugs (preferred): ["michael-basil", "kyle-ingersoll"]
    - A JSON-ish string array: '["michael-basil","kyle-ingersoll"]'
    - A comma-separated string: "michael-basil,kyle-ingersoll"
    - A single slug string: "michael-basil"
  * In override mode, only docs whose `slug` matches one of the listed slugs are rendered.

Optional filtering & framing (via `section.data.leadership_flow`):
  leadership_flow:
    label: string (optional heading shown above the grid)
    designation_type: string (e.g., "program") — keeps authors that have a matching designation
    limit: integer — max number of cards to render after sorting

Other behavior:
- `active` defaults to true when missing.
- Sorting: program_level DESC (by negation) then program_level_date/join_date ASC.

Example usages:
  {% include sections/authors.html section=section %}                         {# all authors #}
  {% include sections/authors.html section=section authors=page.slug %}       {# one author #}
  {% include sections/authors.html section=section authors="a,b" %}           {# subset by slugs #}
{%- endcomment -%}

{%- assign D = section.data | default: {} -%}
{%- assign designation_type = D.leadership_flow.designation_type | default: '' | downcase | strip -%}
{%- assign level_filter = D.level_filter | default: false -%}
{%- assign level_filter_values = nil -%}
{%- assign level_filter_options = nil -%}
{%- assign level_filter_slugs = nil -%}
{%- assign program_level_items = nil -%}
{%- assign program_data = nil -%}
{%- assign level_defaults = nil -%}
{%- assign unranked_label = "Unranked" -%}
{%- assign unranked_color = "white" -%}
{%- if level_filter -%}
  {%- assign level_filter_values = "" | split:"|" -%}
  {%- assign level_filter_options = "" | split:"|" -%}
  {%- assign level_filter_slugs = "" | split:"|" -%}
  {%- assign program_data = site.data.sections.program | default: {} -%}
  {%- assign level_defaults = program_data.level_defaults | default: {} -%}
  {%- assign unranked_label = level_defaults.unranked_label | default: unranked_label -%}
  {%- assign unranked_color = level_defaults.unranked_color | default: unranked_color -%}
  {%- assign program_level_items = program_data.sections
    | where: "type", "levels"
    | map: "data"
    | map: "items"
    | first -%}
{%- endif -%}

{%- comment -%} Normalize include.authors (slugs) to an array {%- endcomment -%}
{%- assign use_override = include.authors and include.authors != "" -%}
{%- if use_override -%}
  {%- assign raw = include.authors -%}
  {%- if raw[0] != nil -%}
    {%- assign slugs = raw -%}
  {%- elsif raw contains '[' and raw contains ']' -%}
    {%- assign tmp = raw | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
    {%- assign slugs = tmp | split:',' | map:'strip' -%}
  {%- elsif raw contains ',' -%}
    {%- assign slugs = raw | split:',' | map:'strip' -%}
  {%- else -%}
    {%- assign slugs = raw | split:'\n' | map:'strip' -%}
  {%- endif -%}
  {%- comment -%} Strict: keep only docs whose slug is explicitly listed {%- endcomment -%}
  {%- assign docs = "" | split:"|" -%}
  {%- for s in slugs -%}
    {%- assign s = s | split:'.' | first | downcase | strip -%}
    {%- assign doc = site.authors | where:"slug", s | first -%}
    {%- if doc -%}{%- assign docs = docs | push: doc -%}{%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign docs = site.authors -%}
{%- endif -%}

{%- comment -%} Filter by slug presence, active, and optional designation_type {%- endcomment -%}
{%- assign filtered = "" | split:"|" -%}
{%- for a in docs -%}
  {%- if a.slug and a.slug != '' -%}
    {%- assign show = a.active | default:true -%}
    {%- if show and designation_type != '' -%}
      {%- assign show = false -%}
      {%- assign ld = a.leadership_designations -%}
      {%- if ld and ld.size > 0 -%}
        {%- for item in ld -%}
          {%- assign t = item.type | downcase | strip -%}
          {%- assign v = item.value | default:item.key | to_s | strip -%}
          {%- if t == designation_type and v != '' and v != 'null' -%}
            {%- assign show = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}
    {%- if show -%}
      {%- assign filtered = filtered | push: a -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Sort: program_level DESC (via negation), then by date ASC {%- endcomment -%}
{%- assign entries = "" | split:"|" -%}
{%- for a in filtered -%}
  {%- assign neg_program = a.program_level | times:-1 | plus:1000 | prepend:"0000" | slice:-4,4 -%}
  {%- assign bld = a.program_level_date | default:a.join_date | default:"9999-12-31" -%}
  {% capture entry %}{{ neg_program }}|{{ bld }}|{{ a.slug }}{% endcapture %}
  {%- assign entries = entries | push: entry -%}
{%- endfor -%}
{%- assign entries = entries | sort -%}

{%- if D.leadership_flow and D.leadership_flow.limit -%}
  {%- assign lim = D.leadership_flow.limit | plus:0 -%}
  {%- if lim > 0 and entries.size > lim -%}
    {%- assign entries = entries | slice:0, lim -%}
  {%- endif -%}
{%- endif -%}

{%- assign author_cards = "" | split:"|" -%}
{%- for e in entries -%}
  {%- assign parts = e | split:'|' -%}
  {%- assign slug  = parts[2] -%}
  {%- assign doc   = site.authors | where:"slug", slug | first -%}
  {%- if doc -%}
    {%- assign author_cards = author_cards | push: doc -%}
    {%- if level_filter -%}
      {%- assign level_raw = doc.program_level | default: nil -%}
      {%- assign author_level_label = "" -%}
      {%- assign author_level_color = unranked_color -%}
      {%- assign level_value = -999 -%}
      {%- if level_raw != nil and level_raw != '' and level_raw != 'null' -%}
        {%- assign level_value = level_raw | plus: 0 -%}
      {%- endif -%}
      {%- if program_level_items and level_raw != nil and level_raw != '' and level_raw != 'null' -%}
        {%- assign level_entry = program_level_items | where: "level", level_value | first -%}
        {%- if level_entry -%}
          {%- assign author_level_label = level_entry.label | default: "" -%}
          {%- assign author_level_color = level_entry.color | default: author_level_color -%}
        {%- endif -%}
      {%- endif -%}
      {%- if author_level_label == "" -%}
        {%- assign author_level_label = unranked_label -%}
        {%- assign author_level_color = unranked_color -%}
      {%- endif -%}
      {%- assign level_slug = author_level_label | slugify -%}
      {%- assign level_filter_values = level_filter_values | push: level_slug -%}
      {%- assign option_sort_level = level_value -%}
      {%- if author_level_label == unranked_label -%}
        {%- assign option_sort_level = -999 -%}
      {%- endif -%}
      {%- assign sort_value = option_sort_level | plus: 1000 | prepend: "0000" | slice: -4, 4 -%}
      {%- capture option_key -%}{{ sort_value }}|||{{ level_slug }}|||{{ author_level_label }}|||{{ author_level_color }}{%- endcapture -%}
      {%- unless level_filter_slugs contains level_slug -%}
        {%- assign level_filter_slugs = level_filter_slugs | push: level_slug -%}
        {%- assign level_filter_options = level_filter_options | push: option_key -%}
      {%- endunless -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- if level_filter and level_filter_options and level_filter_options != empty -%}
  {%- assign level_filter_options = level_filter_options | sort | reverse -%}
{%- endif -%}

{%- assign grid_filter_values = nil -%}
{%- if level_filter -%}
  {%- assign grid_filter_values = level_filter_values -%}
{%- endif -%}

{%- if section -%}
<section class="md-flow card-stream">
  {%- if D.leadership_flow and D.leadership_flow.label -%}
    <h2>{{ D.leadership_flow.label }}</h2>
  {%- endif -%}
  {%- if level_filter and level_filter_options and level_filter_options.size > 0 -%}
    <div class="card-filter" data-card-filter>
      <button type="button"
              class="card-filter-button is-active"
              data-card-filter-button
              data-tag="all">All</button>
      {%- for option in level_filter_options -%}
        {%- assign option_parts = option | split:"|||" -%}
        {%- assign option_slug = option_parts[1] -%}
        {%- assign option_label = option_parts[2] -%}
        {%- assign option_color = option_parts[3] | default: "gray" -%}
        <button type="button"
                class="card-filter-button"
                data-card-filter-button
                data-tag="{{ option_slug }}"
                aria-label="{{ option_label }}"
                title="{{ option_label }}">
          {% include icons/level.svg
             class="md-level-svg card-filter-level"
             color=option_color
             title=option_label %}
        </button>
      {%- endfor -%}
    </div>
  {%- endif -%}
  {% include sections/card-grid.html
    items=author_cards
    item_partial="sections/author.html"
    wrapper_class="card-grid-authors"
    item_filter_values=grid_filter_values %}
</section>
{%- else -%}
  {% include sections/card-grid.html
    items=author_cards
    item_partial="sections/author.html"
    wrapper_class="card-grid-authors"
    item_filter_values=grid_filter_values %}
{%- endif -%}
